-- migrate user_assigned_fg_dg to user_assigned_combination and user_assigned_combination_dg
ALTER TABLE user_assigned_fg_dg DROP CONSTRAINT fk_uafgdg2uafg;
ALTER TABLE user_assigned_fg_dg DROP CONSTRAINT fk_uafgdg2dg;

ALTER INDEX ix_user_assigned_fg_dg_02 RENAME TO ix_user_assigned_fg_dg_02_old;
ALTER TABLE user_assigned_fg_dg RENAME CONSTRAINT pk_user_assigned_fg_dg TO pk_user_assigned_fg_dg_old;
ALTER INDEX pk_user_assigned_fg_dg RENAME TO pk_user_assigned_fg_dg_old;
ALTER TABLE user_assigned_fg_dg RENAME TO user_assigned_fg_dg_old;

-- create sequence to generate Integer values for PK
CREATE SEQUENCE seq_user_assigned_combination START WITH 1 INCREMENT BY 1;

CREATE TABLE user_assigned_fg_combination
(
  user_assigned_fg_id       NUMBER(38, 0) NOT NULL,
  id                        NUMBER(38, 0) NOT NULL
);

CREATE TABLE user_assigned_combination_dg
(
  ua_fg_combination_id      NUMBER(38, 0) NOT NULL,
  data_group_id             VARCHAR2(36)  NOT NULL
);

INSERT INTO user_assigned_fg_combination
(
    user_assigned_fg_id,
    id
)
SELECT
    m.user_assigned_fg_id,
    seq_user_assigned_combination.nextval
FROM
    (
        SELECT DISTINCT
            user_assigned_fg_id
        FROM
            user_assigned_fg_dg_old
    ) m;

COMMIT;

INSERT INTO user_assigned_combination_dg
(
    ua_fg_combination_id,
    data_group_id
)
SELECT
    t.id,
    m.data_group_id
FROM
    user_assigned_fg_dg_old m
    INNER JOIN user_assigned_fg_combination t
    ON m.user_assigned_fg_id = t.user_assigned_fg_id;

COMMIT;

ALTER TABLE user_assigned_fg_combination
    ADD CONSTRAINT pk_uafgc PRIMARY KEY (user_assigned_fg_id, id);
ALTER TABLE user_assigned_fg_combination
    ADD CONSTRAINT uq_uafgc_01 UNIQUE (id);
ALTER TABLE user_assigned_fg_combination
    ADD CONSTRAINT fk_uafgc2uafg FOREIGN KEY (user_assigned_fg_id) REFERENCES user_assigned_function_group (id);

ALTER TABLE user_assigned_combination_dg
    ADD CONSTRAINT pk_uacdg PRIMARY KEY (ua_fg_combination_id, data_group_id);
ALTER TABLE user_assigned_combination_dg
    ADD CONSTRAINT fk_uacdg2uafgc FOREIGN KEY (ua_fg_combination_id) REFERENCES user_assigned_fg_combination (id);
ALTER TABLE user_assigned_combination_dg
    ADD CONSTRAINT fk_uacdg2dg FOREIGN KEY (data_group_id) REFERENCES data_group (id);
CREATE INDEX ix_uacdg_01 ON user_assigned_combination_dg (data_group_id);

-- Update sequence generator table
INSERT INTO sequence_table (sequence_name, next_val)
    VALUES('SEQ_USER_ASSIGNED_FG_COMBINATION', seq_user_assigned_combination.nextval);

COMMIT;

-- new business functions
INSERT INTO BUSINESS_FUNCTION(ID, FUNCTION_CODE, FUNCTION_NAME, RESOURCE_CODE, RESOURCE_NAME)
VALUES
('1079','batch.intracompany.payments', 'Batch - Intracompany Payments', 'payments', 'Payments');

INSERT INTO BUSINESS_FUNCTION(ID, FUNCTION_CODE, FUNCTION_NAME, RESOURCE_CODE, RESOURCE_NAME)
VALUES
('1080','manage.employee.comments', 'Manage Employee Comments', 'comments', 'Comments');

INSERT INTO BUSINESS_FUNCTION(ID, FUNCTION_CODE, FUNCTION_NAME, RESOURCE_CODE, RESOURCE_NAME)
VALUES
('1081','manage.positive.pay', 'Manage Positive Pay', 'payments', 'Payments');

INSERT INTO BUSINESS_FUNCTION(ID, FUNCTION_CODE, FUNCTION_NAME, RESOURCE_CODE, RESOURCE_NAME)
VALUES
('1082','manage.arrangement.alias', 'Manage Arrangement Alias', 'arrangements', 'Arrangements');

INSERT INTO APPLICABLE_FUNCTION_PRIVILEGE
(ID, BUSINESS_FUNCTION_NAME, FUNCTION_RESOURCE_NAME, PRIVILEGE_NAME, SUPPORTS_LIMIT, BUSINESS_FUNCTION_ID, PRIVILEGE_ID)
VALUES
('297', 'Batch - Intracompany Payments', 'Payments', 'view', 0, '1079', '2');

INSERT INTO APPLICABLE_FUNCTION_PRIVILEGE
(ID, BUSINESS_FUNCTION_NAME, FUNCTION_RESOURCE_NAME, PRIVILEGE_NAME, SUPPORTS_LIMIT, BUSINESS_FUNCTION_ID, PRIVILEGE_ID)
VALUES
('298', 'Batch - Intracompany Payments', 'Payments', 'create', 1, '1079', '3');

INSERT INTO APPLICABLE_FUNCTION_PRIVILEGE
(ID, BUSINESS_FUNCTION_NAME, FUNCTION_RESOURCE_NAME, PRIVILEGE_NAME, SUPPORTS_LIMIT, BUSINESS_FUNCTION_ID, PRIVILEGE_ID)
VALUES
('299', 'Batch - Intracompany Payments', 'Payments', 'edit', 0, '1079', '4');

INSERT INTO APPLICABLE_FUNCTION_PRIVILEGE
(ID, BUSINESS_FUNCTION_NAME, FUNCTION_RESOURCE_NAME, PRIVILEGE_NAME, SUPPORTS_LIMIT, BUSINESS_FUNCTION_ID, PRIVILEGE_ID)
VALUES
('300', 'Batch - Intracompany Payments', 'Payments', 'delete', 0, '1079', '5');

INSERT INTO APPLICABLE_FUNCTION_PRIVILEGE
(ID, BUSINESS_FUNCTION_NAME, FUNCTION_RESOURCE_NAME, PRIVILEGE_NAME, SUPPORTS_LIMIT, BUSINESS_FUNCTION_ID, PRIVILEGE_ID)
VALUES
('301', 'Batch - Intracompany Payments', 'Payments', 'approve', 1, '1079', '6');

INSERT INTO APPLICABLE_FUNCTION_PRIVILEGE
(ID, BUSINESS_FUNCTION_NAME, FUNCTION_RESOURCE_NAME, PRIVILEGE_NAME, SUPPORTS_LIMIT, BUSINESS_FUNCTION_ID, PRIVILEGE_ID)
VALUES
('302', 'Batch - Intracompany Payments', 'Payments', 'cancel', 0, '1079', '7');

INSERT INTO APPLICABLE_FUNCTION_PRIVILEGE
(ID, BUSINESS_FUNCTION_NAME, FUNCTION_RESOURCE_NAME, PRIVILEGE_NAME, SUPPORTS_LIMIT, BUSINESS_FUNCTION_ID, PRIVILEGE_ID)
VALUES
('303', 'Manage Employee Comments', 'Comments', 'view', 0, '1080', '2');

INSERT INTO APPLICABLE_FUNCTION_PRIVILEGE
(ID, BUSINESS_FUNCTION_NAME, FUNCTION_RESOURCE_NAME, PRIVILEGE_NAME, SUPPORTS_LIMIT, BUSINESS_FUNCTION_ID, PRIVILEGE_ID)
VALUES
('304', 'Manage Employee Comments', 'Comments', 'create', 0, '1080', '3');

INSERT INTO APPLICABLE_FUNCTION_PRIVILEGE
(ID, BUSINESS_FUNCTION_NAME, FUNCTION_RESOURCE_NAME, PRIVILEGE_NAME, SUPPORTS_LIMIT, BUSINESS_FUNCTION_ID, PRIVILEGE_ID)
VALUES
('305', 'Manage Employee Comments', 'Comments', 'edit', 0, '1080', '4');

INSERT INTO APPLICABLE_FUNCTION_PRIVILEGE
(ID, BUSINESS_FUNCTION_NAME, FUNCTION_RESOURCE_NAME, PRIVILEGE_NAME, SUPPORTS_LIMIT, BUSINESS_FUNCTION_ID, PRIVILEGE_ID)
VALUES
('306', 'Manage Employee Comments', 'Comments', 'delete', 0, '1080', '5');

INSERT INTO APPLICABLE_FUNCTION_PRIVILEGE
(ID, BUSINESS_FUNCTION_NAME, FUNCTION_RESOURCE_NAME, PRIVILEGE_NAME, SUPPORTS_LIMIT, BUSINESS_FUNCTION_ID, PRIVILEGE_ID)
VALUES
('307', 'Manage Positive Pay', 'Payments', 'view', 0, '1081', '2');

INSERT INTO APPLICABLE_FUNCTION_PRIVILEGE
(ID, BUSINESS_FUNCTION_NAME, FUNCTION_RESOURCE_NAME, PRIVILEGE_NAME, SUPPORTS_LIMIT, BUSINESS_FUNCTION_ID, PRIVILEGE_ID)
VALUES
('308', 'Manage Positive Pay', 'Payments', 'create', 0, '1081', '3');

INSERT INTO APPLICABLE_FUNCTION_PRIVILEGE
(ID, BUSINESS_FUNCTION_NAME, FUNCTION_RESOURCE_NAME, PRIVILEGE_NAME, SUPPORTS_LIMIT, BUSINESS_FUNCTION_ID, PRIVILEGE_ID)
VALUES
('309', 'Manage Positive Pay', 'Payments', 'edit', 0, '1081', '4');

INSERT INTO APPLICABLE_FUNCTION_PRIVILEGE
(ID, BUSINESS_FUNCTION_NAME, FUNCTION_RESOURCE_NAME, PRIVILEGE_NAME, SUPPORTS_LIMIT, BUSINESS_FUNCTION_ID, PRIVILEGE_ID)
VALUES
('310', 'Manage Positive Pay', 'Payments', 'delete', 0, '1081', '5');

INSERT INTO APPLICABLE_FUNCTION_PRIVILEGE
(ID, BUSINESS_FUNCTION_NAME, FUNCTION_RESOURCE_NAME, PRIVILEGE_NAME, SUPPORTS_LIMIT, BUSINESS_FUNCTION_ID, PRIVILEGE_ID)
VALUES
('311', 'Manage Positive Pay', 'Payments', 'cancel', 0, '1081', '7');

INSERT INTO APPLICABLE_FUNCTION_PRIVILEGE
(ID, BUSINESS_FUNCTION_NAME, FUNCTION_RESOURCE_NAME, PRIVILEGE_NAME, SUPPORTS_LIMIT, BUSINESS_FUNCTION_ID, PRIVILEGE_ID)
VALUES
('312', 'Manage Arrangement Alias', 'Arrangements', 'edit', 0, '1082', '4');

INSERT INTO ASSIGNABLE_PERMISSION_SET_ITEM
(ASSIGNABLE_PERMISSION_SET_ID, FUNCTION_PRIVILEGE_ID)
VALUES
(1, '297');

INSERT INTO ASSIGNABLE_PERMISSION_SET_ITEM
(ASSIGNABLE_PERMISSION_SET_ID, FUNCTION_PRIVILEGE_ID)
VALUES
(1, '298');

INSERT INTO ASSIGNABLE_PERMISSION_SET_ITEM
(ASSIGNABLE_PERMISSION_SET_ID, FUNCTION_PRIVILEGE_ID)
VALUES
(1, '299');

INSERT INTO ASSIGNABLE_PERMISSION_SET_ITEM
(ASSIGNABLE_PERMISSION_SET_ID, FUNCTION_PRIVILEGE_ID)
VALUES
(1, '300');

INSERT INTO ASSIGNABLE_PERMISSION_SET_ITEM
(ASSIGNABLE_PERMISSION_SET_ID, FUNCTION_PRIVILEGE_ID)
VALUES
(1, '301');

INSERT INTO ASSIGNABLE_PERMISSION_SET_ITEM
(ASSIGNABLE_PERMISSION_SET_ID, FUNCTION_PRIVILEGE_ID)
VALUES
(1, '302');

INSERT INTO ASSIGNABLE_PERMISSION_SET_ITEM
(ASSIGNABLE_PERMISSION_SET_ID, FUNCTION_PRIVILEGE_ID)
VALUES
(1, '303');

INSERT INTO ASSIGNABLE_PERMISSION_SET_ITEM
(ASSIGNABLE_PERMISSION_SET_ID, FUNCTION_PRIVILEGE_ID)
VALUES
(1, '304');

INSERT INTO ASSIGNABLE_PERMISSION_SET_ITEM
(ASSIGNABLE_PERMISSION_SET_ID, FUNCTION_PRIVILEGE_ID)
VALUES
(1, '305');

INSERT INTO ASSIGNABLE_PERMISSION_SET_ITEM
(ASSIGNABLE_PERMISSION_SET_ID, FUNCTION_PRIVILEGE_ID)
VALUES
(1, '306');

INSERT INTO ASSIGNABLE_PERMISSION_SET_ITEM
(ASSIGNABLE_PERMISSION_SET_ID, FUNCTION_PRIVILEGE_ID)
VALUES
(1, '307');

INSERT INTO ASSIGNABLE_PERMISSION_SET_ITEM
(ASSIGNABLE_PERMISSION_SET_ID, FUNCTION_PRIVILEGE_ID)
VALUES
(1, '308');

INSERT INTO ASSIGNABLE_PERMISSION_SET_ITEM
(ASSIGNABLE_PERMISSION_SET_ID, FUNCTION_PRIVILEGE_ID)
VALUES
(1, '309');

INSERT INTO ASSIGNABLE_PERMISSION_SET_ITEM
(ASSIGNABLE_PERMISSION_SET_ID, FUNCTION_PRIVILEGE_ID)
VALUES
(1, '310');

INSERT INTO ASSIGNABLE_PERMISSION_SET_ITEM
(ASSIGNABLE_PERMISSION_SET_ID, FUNCTION_PRIVILEGE_ID)
VALUES
(1, '311');

INSERT INTO ASSIGNABLE_PERMISSION_SET_ITEM
(ASSIGNABLE_PERMISSION_SET_ID, FUNCTION_PRIVILEGE_ID)
VALUES
(1, '312');


commit;

-- Cleanup
-- DROP TABLE user_assigned_fg_dg_old;
-- DROP SEQUENCE seq_user_assigned_combination;
